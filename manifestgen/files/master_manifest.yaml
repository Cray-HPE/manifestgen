---
schema: v1
name: cray-loftsman-manifest
version: 1.0.0
failOnFirstError: True
repositories:
  docker: registry.local
  helm: charts.local
charts: # Will install/upgrade charts in the order below
  - name: "cray-drydock"
    namespace: "loftsman"
    version: 1.0.0
  - name: "cray-istio-init"
    namespace: "istio-system"
    version: 1.1.3
    waitFor:
      script:
        command: >-
          kubectl get crds | grep 'istio.io\|certmanager.k8s.io' | wc -l
        return: "53"
    overrides:
    - global.hub="{repos[docker]}/istio"
  - name: "cray-istio"
    namespace: "istio-system"
    version: 1.1.3
    waitFor:
      pods:
      - istio-pilot
      - istio-citadel
      - istio-galley
      - istio-ingressgateway
      - istio-policy
      - istio-sidecar-injector
    overrides:
    - global.hub="{repos[docker]}/istio"
    - istio.prometheus.hub="{repos[docker]}/prom"
  #  - istio.gateways.istio-ingressgateway.loadBalancerSourceRanges[0]="136.162.0.0/16"
  #  # Disable since we are using the keycloak ansible playbook short term
  # - name: "cray-keycloak"
  #   namespace: "services"
  #   version: 4.7.0
  #   waitFor:
  #     pods:
  #     - cray-keycloak
  #   overrides:
  #   - keycloak.keycloak.image.repository="{repos[docker]}/jboss/keycloak"
  - name: "cray-etcd-operator"
    namespace: "operators"
    version: 0.8.4
    waitFor:
      pods:
      - cray-etcd-operator-etcd-operator-etcd-backup-operator
      - cray-etcd-operator-etcd-operator-etcd-operator
      - cray-etcd-operator-etcd-operator-etcd-restore-operator
    overrides:
    - etcd-operator.etcdCluster.image.repository="{repos[docker]}/coreos/etcd"
    - etcd-operator.etcdOperator.image.repository="{repos[docker]}/coreos/etcd-operator"
    - etcd-operator.restoreOperator.image.repository="{repos[docker]}/coreos/etcd-operator"
    - etcd-operator.backupOperator.image.repository="{repos[docker]}/coreos/etcd-operator"
  - name: "cray-postgres-operator"
    namespace: "services"
    version: 0.0.1
    waitFor:
      script:
        command: >-
          kubectl get crds | grep 'postgresqls.acid.zalan.do' | wc -l
        return: "1"
    overrides:
    - postgres-operator.image.registry="{repos[docker]}"
    - postgres-operator.config.docker_image="{repos[docker]}/acid/spilo-cdp-11:1.5-p70"
  - name: "slingshot_controllers"
    namespace: "services"
    version: 1.0.1
    waitFor:
      helm: true
    overrides:
    - cray-service.imagesHost="{repos[docker]}"
  - name: "slingshot-clis"
    namespace: "services"
    version: 1.0.2
    waitFor:
      helm: true
    overrides:
    - cray-service.imagesHost="{repos[docker]}"
  - name: "cray-rm-pals"
    namespace: "services"
    version: 0.0.1
    waitFor:
      helm: true
    overrides:
    - cray-service.imagesHost="{repos[docker]}"
